## 前言

不是为了测试而测试，测试的目的是在于**提高代码质量、降低错误**。

测试的类型：

-   单元测试（unit testing）**Mocha** 关注输入与输出
-   功能测试（feature testing）**Nightmare** 关注功能效果
-   集成测试（integration testing）**Travis CI** 关注自动化流程

## 单元测试：mocha

Demo: [addKey](https://github.com/yanyue404/addKey)

为数组类型的每一项添加新的键值对，并过滤子项

```js
require('mocha');
const assert = require('assert');
const addKey = require('./');

let arr = [
  {
    id: 1,
    name: '亚瑟',
  },
  {
    id: 2,
    name: '狄仁杰',
  },
  {
    id: 3,
    name: '曹操',
  },
];
describe('addKey', function() {
  it('should return add custom key:', function() {
    addKey(arr, { Address: 'Chinese' });

    assert(arr[0].Address === 'Chinese');
    assert(arr[1].Address === 'Chinese');
    assert(arr[2].Address === 'Chinese');
  });

  it('should return add custom key and filtered correctly:', function() {
    addKey(arr, { isShow: false }, (v, index, array) => {
      index === array.length - 1 ? ((v.name = '铠'), (v.isShow = true)) : '';
    });

    assert(!arr[0].isShow);
    assert(!arr[1].isShow);
    assert(arr[2].isShow); // true
  });

  it('should return omit custom key and filtered correctly:', function() {
    addKey(arr, (v, index, array) => {
      index === array.length - 1 ? ((v.name = '曹操'), (v.isShow = true)) : '';
    });

    assert(!arr[0].isShow);
    assert(!arr[1].isShow);
    assert(arr[2].isShow); // true
  });
});
```

## 功能测试：mocha+nightmare

进行完整的页面级别功能测试，需要使用 [nightmare](https://github.com/segmentio/nightmare) , 它依靠 `electron`作为项目运行的容器进行测试。

解决国内安装 `electron` 困难的方法：

```shell
ELECTRON_MIRROR="https://npm.taobao.org/mirrors/electron/" npm install nightmare -D
```

其他依赖项:

```shell
npm install mocha chai -D
```

-   Demo: [csdwheels](https://github.com/yanyue404/csdwheels)

测试一个分页组件是否成功渲染

**scripts** 命令编写

     "scripts": {
        "demos": "node ./test/server.js",
        "test": "mocha \"./test/**/*.test.js\"",
        "dev": "webpack-dev-server",
        "prettier": "prettier --write \"./src/**/*.{js,css,html}\"",
        "build": "webpack && gulp mini && npm run test"
      }
    

**启动页面测试的 node 环境入口文件**, [http://127.0.0.1:3000/pagination](http://127.0.0.1:3000/pagination) 为分页组件渲染结果

```js
const express = require('express');
const path = require('path');
const app = express();
var port = process.env.PORT || 3000;

app.use('/style', express.static(path.resolve(__dirname, '../style')));
app.use('/dist', express.static(path.resolve(__dirname, '../dist')));
app.use('/src', express.static(path.resolve(__dirname, '../src')));

app.get('/', (req, res) => {
  res.sendFile(path.join(__dirname, 'index.html'));
});
// List
app.get('/pagination', (req, res) => {
  res.sendFile(path.join(__dirname, '/pagination/test.html'));
});

app.listen(port, function() {
  console.log(`app listening on port http://127.0.0.1:${port}`);
});
```

测试方法，组件是否渲染成功，仅测试 `http` 连接是否成功

```js
//  pagination.test.js
const Nightmare = require('nightmare');
const chai = require('chai');

chai.should();

//初始化Nightmare对象
const nightmare = new Nightmare({
  show: true, //是否显示图形化界面
  openDevTools: {
    //配置此项后可显示开发者工具，不配置即不显示
    mode: 'detach',
  },
});

describe('pagination test', function() {
  // 可以关闭超时事件或者直接设置超时时间，默认为两秒关闭
  this.timeout(5000);
  it('http connection', function(done) {
    nightmare
      .goto('http://127.0.0.1:3000/pagination') //打开某网页
      .then(() => {
        done();
      }) //成功后调done执行结果
      .catch(err => {
        {
          console.warn('加载出错', err);
          done(err);
        }
      }); //出错执行什么
  });
});
```

**测试**

```shell
# 启动 node server
npm  run demos

# 运行测试
npm test

> csdwheels@1.3.6 test F:\Source code\csdwheels
> mocha "./test/**/*.test.js"

  backtop test
    √ http connection (1045ms)

  calendar test
    √ http connection (1148ms)

  carousel test
    √ http connection (2911ms)

  eventemitter test
    √ http connection (1037ms)

  magnifier test
    √ http connection (3327ms)

  pagination test
    √ http connection (1058ms)


  6 passing (11s)
```

#### 参考链接

-   [jstraining - 前端的功能测试](https://github.com/ruanyf/jstraining/tree/master/demos#nightmare)
-   [使用 nightmare 进行页面测试介绍](https://1024.page/2016/web/how-to-use-nightmare-for-web-page-test)
-   [初识 mocha + nightmare 前端单元测试](https://zhuanlan.zhihu.com/p/43660578)